From a267590acc53724c72f1b2857e41493690c3ae10 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Myl=C3=A8ne=20Josserand?= <mylene.josserand@collabora.com>
Date: Fri, 6 Mar 2020 15:59:29 +0100
Subject: [PATCH 4/5] bmaptool: CLI: Fail when copying a bmap file
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

The current behavior is that if the user copies the bmap file
by mistake, it prints a warning but it will copy the bmap file
to the block device.

Exemple:

$ echo "test" > in
$ bmaptool create in -o in.bmap
$ bmaptool copy in.bmap out
$ cat out
<?xml version="1.0" ?>
<!-- This file contains the block map for an image file, which is basically
     a list of useful (mapped) block numbers in the image file. In other words,
...

Set the message as an error instead of a warning and update
its content to be more explicit.

Fixes f67fa08 ("bmaptool: do not fail when copying a bmap file")

Signed-off-by: MylÃ¨ne Josserand <mylene.josserand@collabora.com>
---
 bmaptools/CLI.py | 10 ++++------
 1 file changed, 4 insertions(+), 6 deletions(-)

diff --git a/bmaptools/CLI.py b/bmaptools/CLI.py
index ea7b880..4f772db 100644
--- a/bmaptools/CLI.py
+++ b/bmaptools/CLI.py
@@ -384,13 +384,11 @@ def open_files(args):
     (bmap_obj, bmap_path) = find_and_open_bmap(args)
 
     if bmap_path == args.image:
-        # Most probably the specified the bmap file instead of the image file
-        # by mistake.
-        log.warning("image has the same path as the bmap file, dropping bmap")
+        # Most probably the user specified the bmap file instead of the image
+        # file by mistake. Don't let bmaptool copy any data
         bmap_obj.close()
-        bmap_obj = None
-        bmap_path = None
-        args.nobmap = True
+        error_out("Make sure you are flashing your image and not the bmap file "
+                  "because they have the same path.")
 
     # If the destination file is under "/dev", but does not exist, print a
     # warning. This is done in order to be more user-friendly, because
-- 
2.27.0

